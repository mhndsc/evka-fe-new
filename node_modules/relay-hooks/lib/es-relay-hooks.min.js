import{__internal as e,createOperationDescriptor as t,getRequest as r,ConnectionInterface as n,getDataIDsFromFragment as i,getVariablesFromFragment as o,getSelector as s,getFragmentIdentifier as a,getFragment as u,commitMutation as l,requestSubscription as c}from"relay-runtime";export{applyOptimisticMutation,commitLocalUpdate,commitMutation,fetchQuery,graphql,requestSubscription}from"relay-runtime";import f,{useReducer as h,useRef as d,useEffect as p,useMemo as v}from"react";import g from"fbjs/lib/areEqual";import"fbjs/lib/warning";import m from"fbjs/lib/invariant";import b from"@restart/hooks/useMounted";var y=(0,e.createRelayContext)(f),_="network-only",R="store-and-network",k="store-or-network",w="store-only",P="usePagination",q="useRefetchable",D="useFragment",F="forward",A={force:!0};function S(e,n,i){return t(r(e),n,i)}var C=e.fetchQuery;function U(e){var t,r,n,i,o=e.setLoading,s=e.doRetain,a=void 0===s||s,u=e.disposeTemporary,l=null,c=null,f=!1,h=null,d=function(e){f=e,o&&o(f)},p=function(){v(),c&&c.dispose(),g(),c=null,i=null,r=null},v=function(){clearTimeout(t),t=null},g=function(){l&&l.unsubscribe(),h=null};return{fetch:function(e,t,o,s,u,v){void 0===o&&(o="network-only"),void 0===s&&(s=function(e){}),i==e&&r.request.identifier===t.request.identifier||(p(),a&&(c=e.retain(t))),i=e,r=t,g();var m,b=function(e,t,r,n){if("network-only"!==r){var i=e.check(t).status,o="available"===i;if(o||"partial"===n&&"stale"!==i)return{snapshot:e.lookup(t.fragment),full:o}}return{snapshot:null,full:!1}}(e,t,o,v),y=b.snapshot,_="network-only"===(m=o)||"store-and-network"===m||"store-or-network"===m&&!b.full;if(null!=y){var R=!_;u(t,y,!0,R),R&&s(null)}if(l&&l.unsubscribe(),_){var k,w=function(){},P=function(){l===k&&(l=null),f=!1,n=null};return C(e,t).subscribe({unsubscribe:function(){P()},complete:function(){w(),d(!1),P(),s(null)},error:function(e){h=e,w(),d(!1),P(),s(e)},next:function(){var r,i=e.lookup(t.fragment);n=null,(null===(r=t.request.cacheConfig)||void 0===r?void 0:r.poll)&&d(!1),w(),u(t,i)},start:function(e){l=k=e,d(!0)}}),y||(n=new Promise((function(e){w=e}))),{dispose:function(){k&&k.unsubscribe()}}}return{dispose:function(){}}},getData:function(){return{isLoading:f,error:h}},dispose:p,checkAndSuspense:function(e,r){v();var i=n||h;if(e&&i)throw n&&r&&(t=setTimeout((function(){v(),p(),u&&u()}),3e4)),i;return i}}}var M=new Map;function E(e,t,r,n){var i=S(t,r,n),o=e&&M.has(i.request.identifier)?M.get(i.request.identifier):new L;return o.setQuery(t,r,n,i),o}var x=function(){},L=function(){function e(){var e=this;this.forceUpdate=x,this.result=null,this.retry=function(t,r){void 0===r&&(r={});var n=r.fetchPolicy,i=void 0===n?"network-only":n,o=t?S(e.query.request.node,e.query.request.variables,t):e.query;e.fetch(o,i,r),e.resolveResult(),e.forceUpdate()},this.result={retry:this.retry,error:null,data:null,isLoading:!1},this.fetcher=U({disposeTemporary:function(){e.dispose(),e.query&&M.delete(e.query.request.identifier)}})}return e.prototype.setQuery=function(e,t,r,n){this.gqlQuery=e,this.variables=t,this.query=n,this.cacheConfig=r},e.prototype.getForceUpdate=function(){return this.forceUpdate},e.prototype.setForceUpdate=function(e){this.forceUpdate=e},e.prototype.dispose=function(){this.fetcher.dispose(),this.disposeSnapshot()},e.prototype.disposeSnapshot=function(){this.snapshot=null,this.rootSubscription&&(this.rootSubscription.dispose(),this.rootSubscription=null)},e.prototype.fetch=function(e,t,r,n){var i=this;if(this.disposeSnapshot(),n)this.fetcher.dispose();else{var o=r.onComplete,s=!1;this.fetcher.fetch(this.environment,e,t,(function(e){i.resolveResult(),s&&i.forceUpdate(),o&&o(e)}),(function(e,t){i.snapshot||(i.snapshot=t,i.subscribe(t),i.resolveResult(),s&&i.forceUpdate())})),s=!0}},e.prototype.getQuery=function(e,t,r){return e==this.gqlQuery&&r==this.cacheConfig&&t==this.variables&&g(t,this.variables)?this.query:(this.variables=t,this.gqlQuery=e,this.cacheConfig=r,S(e,t,r))},e.prototype.resolveEnvironment=function(e){this.resolve(e,this.gqlQuery,this.variables,this.options)},e.prototype.resolve=function(e,t,r,n){var i=this.getQuery(t,r,n.networkCacheConfig),o=n.fetchPolicy,s=void 0===o?"store-or-network":o,a=n.fetchKey,u=n.skip;this.options=n,(!this.query||i.request.identifier!==this.query.request.identifier||e!==this.environment||s!==this.fetchPolicy||a!==this.fetchKey||u!==this.skip)&&(this.environment=e,this.query=i,this.skip=u,this.fetchPolicy=s,this.fetchKey=a,this.fetch(i,s,n,u),this.resolveResult())},e.prototype.checkAndSuspense=function(e,t){t&&(this.setForceUpdate(x),M.set(this.query.request.identifier,this));var r=this.fetcher.checkAndSuspense(e,t);return t&&M.delete(this.query.request.identifier),r},e.prototype.getData=function(){return this.result},e.prototype.resolveResult=function(){var e=this.fetcher.getData();this.result={retry:this.retry,error:e.error,data:this.snapshot?this.snapshot.data:null,isLoading:e.isLoading}},e.prototype.subscribe=function(e){var t=this;this.rootSubscription&&this.rootSubscription.dispose(),this.rootSubscription=this.environment.subscribe(e,(function(e){t.snapshot=e,t.resolveResult(),t.forceUpdate()}))},e}();function N(){return h((function(e){return e+1}),0)[1]}function j(){return f.useContext(y).environment}var O=function(e,t,r,n){var i=j(),o=N(),s=d();null==s.current&&(s.current={queryFetcher:E(n,e,t,r.networkCacheConfig)}),p((function(){return function(){return s.current.queryFetcher.dispose()}}),[]);var a=s.current.queryFetcher;return a.resolve(i,e,t,r),a.checkAndSuspense(n,n),a.setForceUpdate(o),a.getData()},Q=function(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),O(e,t,r,!1)},T=function(e,t,r){var n;return void 0===t&&(t={}),void 0===r&&(r={}),r.networkCacheConfig=null!==(n=r.networkCacheConfig)&&void 0!==n?n:A,O(e,t,r,!0)},H=function(){},I=function(e){void 0===e&&(e=!1);var t=new L;return{next:function(e,r,n,i){var o;void 0===n&&(n={}),void 0===i&&(i={}),i.networkCacheConfig=null!==(o=i.networkCacheConfig)&&void 0!==o?o:A,t.resolve(e,r,n,i);var s=t.checkAndSuspense();return s?s instanceof Error?Promise.reject(s):s:Promise.resolve()},subscribe:function(e){return t.setForceUpdate(e),function(){t.getForceUpdate()===e&&t.setForceUpdate(H)}},getValue:function(r){return t.resolveEnvironment(r),t.checkAndSuspense(e),t.getData()},dispose:function(){t.dispose(),t.setForceUpdate(H),t=new L}}},V=function(){return I(!0)},G=function(){return I(!1)},K=function(e){var t=N(),r=j();return p((function(){return e.subscribe(t)}),[e]),e.getValue(r)},B=function(){return(B=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function X(e,t){for(var r=e,n=0,i=t;n<i.length;n++){var o=i[n];if(null==r)return null;"number"==typeof o?(Array.isArray(r)||m(!1),r=r[o]):(("object"!=typeof r||Array.isArray(r))&&m(!1),r=r[o])}return r}function z(e,t,r){var i,o;if(null==r)return{cursor:null,hasMore:!1};var s=n.get(),a=s.EDGES,u=s.PAGE_INFO,l=s.HAS_NEXT_PAGE,c=s.HAS_PREV_PAGE,f=s.END_CURSOR,h=s.START_CURSOR;"object"!=typeof r&&m(!1);var d=r[a],p=r[u];if(null==d||null==p)return{cursor:null,hasMore:!1};Array.isArray(d)||m(!1),"object"!=typeof p&&m(!1);var v="forward"===e?null!==(i=p[f])&&void 0!==i?i:null:null!==(o=p[h])&&void 0!==o?o:null;return null!==v&&"string"!=typeof v&&m(!1),{cursor:v,hasMore:"forward"===e?null!=v&&!0===p[l]:null!=v&&!0===p[c]}}function J(e,t){var r,n;!0===(null===(r=e.metadata)||void 0===r?void 0:r.plural)&&m(!1);var i=null===(n=e.metadata)||void 0===n?void 0:n.refetch;null==i&&m(!1);var o=i.operation.default?i.operation.default:i.operation,s=i.fragmentPathInResult;"string"==typeof o&&m(!1);var a=i.identifierField;return null!=a&&"string"!=typeof a&&m(!1),{fragmentRefPathInResponse:s,identifierField:a,refetchableRequest:o,refetchMetadata:i}}function W(e,t){var r,n,i=J(e),o=i.refetchableRequest,s=i.refetchMetadata,a=s.connection;null==a&&m(!1);var u=a.path,l=(null!==(n=null===(r=e.metadata)||void 0===r?void 0:r.connection)&&void 0!==n?n:[])[0];null==l&&m(!1);var c=s.identifierField;return null!=c&&"string"!=typeof c&&m(!1),{connectionPathInFragmentData:u,identifierField:c,paginationRequest:o,paginationMetadata:a,stream:!0===l.stream}}var Y=e.getPromiseForActiveRequest;function Z(e){var t=$(e);return Array.isArray(e)?{snapshot:e,data:e.map((function(e){return e.data})),isMissingData:t}:{snapshot:e,data:e.data,isMissingData:t}}function $(e){return Array.isArray(e)?e.some((function(e){return e.isMissingData})):e.isMissingData}var ee=function(){function e(e){var t=this;this.unmounted=!1,this.refetchable=!1,this.pagination=!1,this.refetch=function(e,r){var n,i,o,s;if(!0===t.unmounted)return{dispose:function(){}};var u,l,c=J(t._fragment),f=c.fragmentRefPathInResponse,h=c.identifierField,d=c.refetchableRequest,p=t.getData().data,v=null!=h&&null!=p&&"object"==typeof p?p[h]:null;null==t._selector?(u={},l={}):"PluralReaderSelector"===t._selector.kind?(u=null!==(i=null===(n=t._selector.selectors[0])||void 0===n?void 0:n.owner.variables)&&void 0!==i?i:{},l=null!==(s=null===(o=t._selector.selectors[0])||void 0===o?void 0:o.variables)&&void 0!==s?s:{}):(u=t._selector.owner.variables,l=t._selector.variables);var g=B(B(B({},u),l),e);null==h||e.hasOwnProperty("id")||(g.id=v),t.pagination&&(t.fetcherNext.dispose(),t.fetcherPrevious.dispose());var m=S(d,g,A);return t.fetcherRefecth.fetch(t._environment,m,null==r?void 0:r.fetchPolicy,null==r?void 0:r.onComplete,(function(e,r){var n=X(r.data,f),i=t.isEqualsFragmentRef(t._fragmentRefRefetch||t._fragmentRef,n),o=$(r);i&&!o||(t._fragmentRefRefetch=n,t._idfragmentrefetch=a(t._fragment,n),t.lookup(t._fragment,n),t.subscribe(),t.resolverData.isMissingData=o,t.resolverData.owner=e.request,t.refreshHooks())}),null==r?void 0:r.UNSTABLE_renderPolicy)},this.loadPrevious=function(e,r){return t.loadMore("backward",e,r)},this.loadNext=function(e,r){return t.loadMore("forward",e,r)},this.loadMore=function(e,r,n){var i,o=null!==(i=null==n?void 0:n.onComplete)&&void 0!==i?i:function(){},s=t.getData().data,a="backward"===e?t.fetcherPrevious:t.fetcherNext;if(!0===t.unmounted)return{dispose:function(){}};if(null==t._selector)return o(null),{dispose:function(){}};if(t._environment.isRequestActive(t._selector.owner.identifier)||!0===a.getData().isLoading||null==s)return o(null),{dispose:function(){}};(null==t._selector||"PluralReaderSelector"===t._selector.kind)&&m(!1);var u=W(t._fragment),l=u.paginationRequest,c=u.paginationMetadata,f=u.identifierField,h=u.connectionPathInFragmentData,d=null!=f&&null!=s&&"object"==typeof s?s[f]:null,p=t._selector.variables,v=null==n?void 0:n.UNSTABLE_extraVariables,g=B(B({},t._selector.owner.variables),p),b=function(e,t,r,n,i,o){var s,a,u=o.backward,l=o.forward;if("backward"===e){(null==u||null==u.count||null==u.cursor)&&m(!1);var c=B(B(B({},n),i),((s={})[u.cursor]=r,s[u.count]=t,s));return l&&l.cursor&&(c[l.cursor]=null),l&&l.count&&(c[l.count]=null),c}(null==l||null==l.count||null==l.cursor)&&m(!1);var f=B(B(B({},n),i),((a={})[l.cursor]=r,a[l.count]=t,a));return u&&u.cursor&&(f[u.cursor]=null),u&&u.count&&(f[u.count]=null),f}(e,r,function(e,t,r,n){return z(e,0,X(r,n))}(e,0,s,h).cursor,g,B({},v),c);null!=f&&(b.id=d);var y=S(l,b,A);return a.fetch(t._environment,y,void 0,o,(function(){}))},this.name=e,this.pagination="usePagination"===e,this.refetchable="useRefetchable"===e||this.pagination;var r=function(e){return t.refreshHooks()};this.refetchable&&(this.fetcherRefecth=U({setLoading:r,doRetain:!0})),this.pagination&&(this.fetcherNext=U({setLoading:r}),this.fetcherPrevious=U({setLoading:r}))}return e.prototype.setForceUpdate=function(e){var t=this;this.refreshHooks=function(){t.resolveResult(),e()}},e.prototype.setUnmounted=function(){this.unmounted=!0},e.prototype.isEqualsFragmentRef=function(e,t){if(this._fragmentRef!==t){var r=i(this._fragment,e),n=i(this._fragment,t);if(!g(r,n)||!g(this.getFragmentVariables(t),this.getFragmentVariables(e)))return!1}return!0},e.prototype.dispose=function(){this.unsubscribe(),this.fetcherNext&&this.fetcherNext.dispose(),this.fetcherPrevious&&this.fetcherPrevious.dispose(),this._idfragmentrefetch=null,this._fragmentRefRefetch=null,this.fetcherRefecth&&this.fetcherRefecth.dispose()},e.prototype.getFragmentVariables=function(e){return void 0===e&&(e=this._fragmentRef),o(this._fragment,e)},e.prototype.resolve=function(e,t,r,n){(!this.resolverData||this._environment!==e||t!==this._idfragment&&(!this._idfragmentrefetch||this._idfragmentrefetch&&t!==this._idfragmentrefetch))&&(this._fragment=r,this._fragmentRef=n,this._idfragment=t,this._selector=null,this.dispose(),this._environment=e,this.lookup(r,this._fragmentRef),this.resolveResult())},e.prototype.lookup=function(e,t){if(null!=t)if(e.metadata&&e.metadata.plural&&!0===e.metadata.plural&&0===t.length)this.resolverData={data:[]};else{this._selector=s(e,t);var r,n,i=(r=this._environment,"PluralReaderSelector"===(n=this._selector).kind?n.selectors.map((function(e){return r.lookup(e)})):r.lookup(n));this.resolverData=Z(i),this.resolverData.owner=this._selector?"PluralReaderSelector"===this._selector.kind?this._selector.selectors[0].owner:this._selector.owner:null}else this.resolverData={data:null}},e.prototype.checkAndSuspense=function(e){var t,r=this;if(e&&this.resolverData.isMissingData&&this.resolverData.owner){var n=this.resolverData.owner,i=function(e,t){var r;return(null!==(r=Y(t,e))&&void 0!==r?r:function(e,t){return e.getOperationTracker().getPromiseForPendingOperationsAffectingOwner(t)}(t,e))||null}(n,this._environment),o=null!==(t=n.node.params.name)&&void 0!==t?t:"Unknown Parent Query";if(null!=i){var s=i.then((function(){r._idfragmentrefetch?r.resolveResult():(r._idfragment=null,r.dispose())})).catch((function(e){r._idfragmentrefetch?r.resolveResult():(r._idfragment=null,r.dispose())}));throw s.displayName="Relay("+o+")",this.unsubscribe(),this.refreshHooks=function(){},s}}this.fetcherRefecth&&this.fetcherRefecth.checkAndSuspense(e)},e.prototype.getData=function(){return this.result},e.prototype.resolveResult=function(){var e=this.resolverData.data;if(this.refetchable||this.pagination){var t=this.fetcherRefecth.getData(),r=t.isLoading,n=t.error,i=this.refetch;if(!this.pagination)return void(this.result={data:e,isLoading:r,error:n,refetch:i});var o=X(e,W(this._fragment).connectionPathInFragmentData),s=z("forward",0,o).hasMore,a=z("backward",0,o).hasMore,u=this.fetcherNext.getData(),l=u.isLoading,c=u.error,f=this.fetcherPrevious.getData();this.result={data:e,hasNext:s,isLoadingNext:l,hasPrevious:a,isLoadingPrevious:f.isLoading,isLoading:r,errorNext:c,errorPrevious:f.error,error:n,refetch:i,loadNext:this.loadNext,loadPrevious:this.loadPrevious}}else this.result=e},e.prototype.unsubscribe=function(){this._disposable&&this._disposable.dispose()},e.prototype.subscribe=function(){var e=this,t=this._environment,r=this.resolverData.snapshot;this.unsubscribe();var n=[];r&&(Array.isArray(r)?r.forEach((function(r,i){n.push(t.subscribe(r,(function(t){e.resolverData.snapshot[i]=t,e.resolverData.data[i]=t.data,e.resolverData.isMissingData=!1,e.refreshHooks()})))})):n.push(t.subscribe(r,(function(t){e.resolverData=Z(t),e.resolverData.isMissingData=!1,e.refreshHooks()})))),this._disposable={dispose:function(){n.map((function(e){return e.dispose()})),e._disposable=void 0}}},e}();function te(e,t,r,n){var i=j(),o=N(),s=d(null);null==s.current&&(s.current={resolver:new ee(n)});var l=s.current.resolver;p((function(){return function(){s.current.resolver.setUnmounted()}}),[]),p((function(){return function(){l.dispose()}}),[l]);var c=v((function(){return u(e)}),[e]),f=v((function(){return a(c,t)}),[c,t]);return p((function(){return l.subscribe(),function(){l.unsubscribe()}}),[l,f,i]),l.resolve(i,f,c,t),l.checkAndSuspense(r),l.setForceUpdate(o),[l.getData(),l]}function re(e,t){return te(e,t,!1,"useFragment")[0]}function ne(e,t){return te(e,t,!0,"useFragment")[0]}var ie=f.useCallback,oe=f.useState;function se(e,t,r){void 0===t&&(t={});var n=oe({loading:!1,data:null,error:null}),i=n[0],o=n[1],s=b(),a=j(),u=r||a,c=t.configs,f=t.variables,h=t.uploadables,d=t.onCompleted,p=t.onError,v=t.optimisticUpdater,g=t.optimisticResponse,y=t.updater;return[ie((function(t){var r=B({configs:c,variables:f,uploadables:h,onCompleted:d,onError:p,optimisticUpdater:v,optimisticResponse:g,updater:y},t);return r.variables||m(!1),s()&&o({loading:!0,data:r.optimisticResponse,error:null}),new Promise((function(t,n){function i(e){s()&&o({loading:!1,data:null,error:e}),r.onError?(r.onError(e),t(null)):n(e)}l(u,B(B({},r),{mutation:e,variables:r.variables,onCompleted:function(e,n){n?i(n):(s()&&o({loading:!1,data:e,error:null}),r.onCompleted&&r.onCompleted(e),t(e))},onError:i}))}))}),[u,c,e,f,h,d,p,v,g,y,s]),i]}function ae(e,t){var r=j(),n=t&&t.skip;p((function(){if(!n)return c(r,e).dispose}),[r,e,n])}function ue(e,t){return te(e,t,!1,"usePagination")[0]}function le(e,t){return te(e,t,!0,"usePagination")[0]}function ce(e,t){return te(e,t,!1,"useRefetchable")[0]}function fe(e,t){return te(e,t,!0,"useRefetchable")[0]}var he=function(e){var t=f.useMemo((function(){return{environment:e.environment}}),[e.environment]);return f.createElement(y.Provider,{value:t},e.children)};export{F as FORWARD,D as FRAGMENT_NAME,_ as NETWORK_ONLY,P as PAGINATION_NAME,q as REFETCHABLE_NAME,y as ReactRelayContext,he as RelayEnvironmentProvider,w as STORE_ONLY,k as STORE_OR_NETWORK,R as STORE_THEN_NETWORK,V as loadLazyQuery,G as loadQuery,re as useFragment,T as useLazyLoadQuery,se as useMutation,te as useOssFragment,ue as usePagination,le as usePaginationFragment,K as usePreloadedQuery,Q as useQuery,ce as useRefetchable,fe as useRefetchableFragment,j as useRelayEnvironment,ae as useSubscription,ne as useSuspenseFragment};
//# sourceMappingURL=es-relay-hooks.min.js.map
